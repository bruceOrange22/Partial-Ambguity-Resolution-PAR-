clear all
clc  
xa = [-2412274.872600   4702719.368139   3558241.985322];
xb = [25.080941        -1.547383        28.618787       -29.934311        -5.419590        38.968843      -120.731580         3.158387         1.467129        -0.280124         4.977204        22.428150        -0.573298        -5.245942        -5.050115        -0.769736        -0.883036        11.488706         5.690747        -3.321355        -1.446589         1.695131];
Qb=[6.415431         5.879557         6.025277         6.066624         2.782362         6.250826        -0.416673        -0.303125        -0.127372         1.477630        -1.885044        -0.631520        -3.826940         1.197928         1.638839         0.295436        -1.795463        -4.533349        -1.702994        -2.937833         1.142598        -1.457636
     5.879557         7.097586         7.567253         2.106251         1.129646         6.320723         0.948327         1.315089         0.343766         0.976917        -0.702758        -2.541885        -3.180900         1.297691         1.271394         0.538014        -0.720202        -4.285214        -2.088549        -2.830338         0.755415        -0.543417
     6.025277         7.567253         9.272770         3.542302         0.296189         8.519485         1.201540         2.529640         1.943541         1.537639         0.557315        -0.256666        -2.057339         2.953966         2.023417         0.709425         0.714834        -4.137083         0.086427        -1.549737         1.189000         0.430952
     6.066624         2.106251         3.542302        16.102669         4.458584         8.017321        -3.086006        -1.967006         1.520024         3.185254        -1.984608         7.947758        -2.330958         3.433888         3.310825        -0.070859        -1.370713        -3.553649         3.401063        -0.161401         2.463041        -1.534626
     2.782362         1.129646         0.296189         4.458584         2.717905         1.192653        -1.287832        -1.937279        -1.238735         0.636382        -2.253058        -0.062451        -2.538037        -0.488213         0.500185        -0.153552        -2.233300        -2.004042        -1.526252        -1.886981         0.492091        -1.742208
     6.250826         6.320723         8.519485         8.017321         1.192653         9.531602         0.054465         1.767787         2.555279         2.312258         0.352341         3.184439        -1.705931         3.886334         2.784636         0.566994         0.726205        -4.001338         2.021527        -0.619296         1.787985         0.272452
    -0.416673         0.948327         1.201540        -3.086006        -1.287832         0.054465         1.064944         1.261641         0.367815        -0.390166         0.921262        -1.488597         0.503408         0.077737        -0.286321         0.189022         0.837865         0.193352        -0.300433         0.083763        -0.301701         0.712379
    -0.303125         1.315089         2.529640        -1.967006        -1.937279         1.767787         1.261641         2.208727         1.614394         0.046760         1.903138         0.292094         1.378910         1.368342         0.299672         0.322589         1.956077         0.308778         1.394355         1.081634         0.036158         1.471628
    -0.127372         0.343766         1.943541         1.520024        -1.238735         2.555279         0.367815         1.614394         2.091986         0.650360         1.743418         2.973475         1.652735         2.094863         0.892830         0.211604         1.964937         0.414554         2.902226         1.806653         0.502899         1.348122
     1.477630         0.976917         1.537639         3.185254         0.636382         2.312258        -0.390166         0.046760         0.650360         0.737133        -0.091088         1.678820        -0.360676         1.054745         0.822806         0.067893         0.051133        -0.871795         0.923551         0.064015         0.568377        -0.071234
    -1.885044        -0.702758         0.557315        -1.984608        -2.253058         0.352341         0.921262         1.903138         1.743418        -0.091088         2.212536         1.548898         2.405956         1.271865         0.099647         0.180474         2.307301         1.517460         2.376581         2.080790        -0.071234         1.709127
    -0.631520        -2.541885        -0.256666         7.947758        -0.062451         3.184439        -1.488597         0.292094         2.973475         1.678820         1.548898         8.527793         2.648002         3.323789         1.860591        -0.076889         2.099219         1.236011         6.127148         3.621087         1.297371         1.196908
    -3.826940        -3.180900        -2.057339        -2.330958        -2.538037        -1.705931         0.503408         1.378910         1.652735        -0.360676         2.405956         2.648002         3.477617         0.889554        -0.272562        -0.013905         2.523059         2.954295         3.198671         3.080441        -0.279697         1.859639
     1.197928         1.297691         2.953966         3.433888        -0.488213         3.886334         0.077737         1.368342         2.094863         1.054745         1.271865         3.323789         0.889554         2.420544         1.318735         0.240359         1.540001        -0.483000         2.787025         1.312458         0.814796         0.982688
     1.638839         1.271394         2.023417         3.310825         0.500185         2.784636        -0.286321         0.299672         0.892830         0.822806         0.099647         1.860591        -0.272562         1.318735         0.948894         0.113544         0.261820        -0.959194         1.151393         0.165729         0.635446         0.076254
     0.295436         0.538014         0.709425        -0.070859        -0.153552         0.566994         0.189022         0.322589         0.211604         0.067893         0.180474        -0.076889        -0.013905         0.240359         0.113544         0.068244         0.187541        -0.201547         0.062909        -0.024686         0.051700         0.138755
    -1.795463        -0.720202         0.714834        -1.370713        -2.233300         0.726205         0.837865         1.956077         1.964937         0.051133         2.307301         2.099219         2.523059         1.540001         0.261820         0.187541         2.443489         1.507508         2.767104         2.275215         0.038740         1.783353
    -4.533349        -4.285214        -4.137083        -3.553649        -2.004042        -4.001338         0.193352         0.308778         0.414554        -0.871795         1.517460         1.236011         2.954295        -0.483000        -0.959194        -0.201547         1.507508         3.283284         1.796444         2.414374        -0.674927         1.172597
    -1.702994        -2.088549         0.086427         3.401063        -1.526252         2.021527        -0.300433         1.394355         2.902226         0.923551         2.376581         6.127148         3.198671         2.787025         1.151393         0.062909         2.767104         1.796444         5.234540         3.560171         0.713349         1.836925
    -2.937833        -2.830338        -1.549737        -0.161401        -1.886981        -0.619296         0.083763         1.081634         1.806653         0.064015         2.080790         3.621087         3.080441         1.312458         0.165729        -0.024686         2.275215         2.414374         3.560171         2.982273         0.050119         1.609618
     1.142598         0.755415         1.189000         2.463041         0.492091         1.787985        -0.301701         0.036158         0.502899         0.568377        -0.071234         1.297371        -0.279697         0.814796         0.635446         0.051700         0.038740        -0.674927         0.713349         0.050119         0.440759        -0.054465
    -1.457636        -0.543417         0.430952        -1.534626        -1.742208         0.272452         0.712379         1.471628         1.348122        -0.071234         1.709127         1.196908         1.859639         0.982688         0.076254         0.138755         1.783353         1.172597         1.836925         1.609618        -0.054465         1.322957];

Qab = [-0.168771         0.349603         0.075001        -1.810326        -0.296864        -0.607240         0.403928         0.189953        -0.341664        -0.341868         0.002237        -1.418371        -0.167372        -0.478391        -0.353262         0.035542        -0.090813        -0.007141        -0.848598        -0.400683        -0.264354         0.001730
    -0.959358        -2.101242        -2.379289         1.539830         0.608917        -1.382844        -0.889780        -1.106440        -0.329989         0.041378        -0.465820         1.464963         0.323850        -0.342567        -0.089789        -0.236897        -0.410442         0.767674         0.602599         0.520281         0.031996        -0.360202
    -1.191988        -1.464855        -1.380866        -0.059928        -0.304713        -0.982777        -0.212624        -0.147177         0.163022        -0.096934         0.301422         0.971661         0.821869        -0.014104        -0.133728        -0.095437         0.337024         0.914946         0.799239         0.794107        -0.074955         0.233079];
%     ratio threshold
global Thres_ratio
Thres_ratio = 3;
xa = xa';
xb = xb';
% % delete before resolution by lambda
% list = [4, 6];
% [Qb, Qab, xb] = deleteQ_Qab_xb(Qb, Qab, xb, list);

 [afixed,sqnorm,Ps,Qzhat,Z,nfixed,mu, r_Z]=LAMBDA(xb,Qb,5);
 unfixed = size(xb,1) - nfixed;

 ratio = sqnorm(2)/sqnorm(1);
% move the unfixed ambiguities to front
 xb1 = r_Z*xb;
 % move the convariance of unfixed ambiguities to front
 Qb = r_Z*Qb*r_Z';
 Qab = Qab*r_Z';
 
%get differences between the float and fixed ambiguities
 db = xb1(unfixed+1:end)-afixed(:,1);
 Qb1 = Qb(unfixed+1:end, unfixed+1:end);
 Qab = Qab(:,unfixed+1:end);
%  fixed solution
 xa = xa - Qab*(Qb1\db);
% constrain unfixed ambiguities
 Qb_ab = Qb(1:unfixed,unfixed+1:end);
 xb1(1:unfixed) = xb1(1:unfixed) - Qb_ab*(Qb1\db);
